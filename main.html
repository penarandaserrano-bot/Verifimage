<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Verifimage — Prototipo (IDB)</title>
  <link rel="icon" href="https://i.ibb.co/tTp5rj1B/Chat-GPT-Image-11-nov-2025-09-19-35-p-m.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <style>
:root{
  --bg:#05070b;
  --bg-alt:#050910;
  --card:#0d1520;
  --card-soft:#0b111b;
  --muted:#9aa6b2;
  --accent:#16a34a;
  --accent-soft:#22c55e;
  --accent-2:#57E496;
  --text:#edf2ff;
  --danger:#e11d48;
  --border-subtle:rgba(148,163,184,0.16);
  --border-strong:rgba(148,163,184,0.35);
  --glass:rgba(15,23,42,0.82);
  --shadow-soft:0 18px 45px rgba(0,0,0,0.72);
  --shadow-inner:inset 0 0 0 1px rgba(15,23,42,0.9);
  --radius-lg:18px;
  --radius-md:12px;
  --radius-sm:8px;
  --transition-fast:180ms ease-out;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  background:
    radial-gradient(circle at 0 0,rgba(56,189,248,0.12),transparent 55%),
    radial-gradient(circle at 100% 100%,rgba(34,197,94,0.13),transparent 55%),
    radial-gradient(circle at 50% -10%,rgba(129,140,248,0.10),transparent 60%),
    var(--bg);
}

/* LAYOUT BASE */
.container{
  max-width:1120px;
  margin:26px auto 40px;
  padding:0 20px 10px;
}
header.nav{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:18px;
}
.brand{
  display:flex;
  align-items:center;
  gap:16px;
}
.brand-logo-wrap{
  display:flex;
  align-items:center;
  justify-content:center;
  height:64px;
  width:64px;
  border-radius:22px;
  background:radial-gradient(circle at 30% 0,#4ade80,#16a34a);
  box-shadow:
    0 14px 35px rgba(34,197,94,0.45),
    0 0 0 1px rgba(15,23,42,0.95);
  overflow:hidden;
}
.brand-logo-wrap img{
  width:100%;
  height:100%;
  object-fit:cover;
}
h1{
  margin:0;
  font-size:22px;
  letter-spacing:0.02em;
}
.muted{
  color:var(--muted);
  font-size:13px;
}

/* CARDS / PANEL */
.card{
  position:relative;
  background:
    radial-gradient(circle at 0 0,rgba(148,163,184,0.08),transparent 60%),
    radial-gradient(circle at 100% 0,rgba(34,197,94,0.09),transparent 60%),
    var(--glass);
  border-radius:var(--radius-lg);
  border:1px solid rgba(15,23,42,0.9);
  box-shadow:var(--shadow-soft);
  padding:18px 18px 16px;
  backdrop-filter:blur(16px);
}
.card::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  border:1px solid rgba(255,255,255,0.02);
  pointer-events:none;
}
.card-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}

/* GRID PRINCIPAL */
.grid{
  display:grid;
  grid-template-columns:minmax(0,1.4fr) minmax(320px,1fr);
  gap:20px;
  align-items:flex-start;
}
@media(max-width:960px){
  .grid{
    grid-template-columns:1fr;
  }
}

/* ZONA DE SUBIDA */
.upload-area{
  border-radius:var(--radius-lg);
  border:1px dashed rgba(148,163,184,0.35);
  padding:22px 18px;
  min-height:220px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:12px;
  background:
    radial-gradient(circle at 0 0,rgba(56,189,248,0.16),transparent 60%),
    radial-gradient(circle at 100% 100%,rgba(34,197,94,0.12),transparent 70%),
    linear-gradient(145deg,#020617,#020714);
  box-shadow:
    var(--shadow-inner),
    0 14px 40px rgba(15,23,42,0.9);
  transition:box-shadow var(--transition-fast),border-color var(--transition-fast),transform var(--transition-fast),background var(--transition-fast);
}
.upload-area:hover{
  border-color:var(--accent-soft);
  box-shadow:
    0 0 0 1px rgba(34,197,94,0.45),
    0 18px 42px rgba(22,163,74,0.45);
  transform:translateY(-1px);
}
#dropText{
  font-size:14px;
  color:var(--muted);
}
.thumb{
  max-width:100%;
  max-height:280px;
  border-radius:var(--radius-md);
  border:1px solid var(--border-subtle);
  box-shadow:0 14px 35px rgba(0,0,0,0.8);
}

/* BOTONES */
.btn{
  position:relative;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:9px 16px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  font-weight:600;
  font-size:14px;
  color:#020617;
  background:linear-gradient(135deg,var(--accent),var(--accent-soft));
  box-shadow:
    0 10px 28px rgba(34,197,94,0.55),
    0 0 0 1px rgba(15,23,42,0.9);
  transition:transform var(--transition-fast),box-shadow var(--transition-fast),filter var(--transition-fast),background 220ms ease-out;
}
.btn::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  border:1px solid rgba(255,255,255,0.18);
  pointer-events:none;
}
.btn:hover{
  transform:translateY(-1px);
  filter:brightness(1.05);
  box-shadow:
    0 14px 34px rgba(34,197,94,0.7),
    0 0 0 1px rgba(15,23,42,0.95);
}
.btn:active{
  transform:translateY(1px) scale(.98);
  box-shadow:
    0 6px 16px rgba(22,163,74,0.6),
    0 0 0 1px rgba(15,23,42,0.9);
}
.btn.secondary{
  background:radial-gradient(circle at 0 0,rgba(148,163,184,0.24),transparent 60%),#020617;
  color:var(--muted);
  box-shadow:
    0 8px 20px rgba(15,23,42,0.95),
    0 0 0 1px rgba(30,64,175,0.65);
}
.btn.secondary:hover{
  color:#e5e7eb;
  box-shadow:
    0 12px 24px rgba(15,23,42,0.9),
    0 0 0 1px rgba(59,130,246,0.9);
}

/* INPUTS */
input[type="text"],
input[type="password"],
input[type="search"]{
  width:100%;
  padding:9px 11px;
  border-radius:var(--radius-md);
  border:1px solid rgba(51,65,85,0.85);
  background:radial-gradient(circle at 0 0,rgba(30,64,175,0.16),transparent 70%),#020617;
  color:var(--text);
  font-size:14px;
  outline:none;
  box-shadow:0 0 0 1px rgba(15,23,42,0.85);
  transition:border-color var(--transition-fast),box-shadow var(--transition-fast),background var(--transition-fast),transform var(--transition-fast);
}
input[type="text"]:focus,
input[type="password"]:focus,
input[type="search"]:focus{
  border-color:rgba(56,189,248,0.9);
  box-shadow:
    0 0 0 1px rgba(15,23,42,1),
    0 0 0 1px rgba(56,189,248,0.85),
    0 14px 32px rgba(15,23,42,0.95);
  transform:translateY(-0.5px);
}

/* KV / METADATA */
.kv{
  margin-top:6px;
  padding:7px 9px;
  border-radius:var(--radius-md);
  font-size:13px;
  color:var(--muted);
  background:linear-gradient(135deg,rgba(15,23,42,0.96),rgba(15,23,42,0.88));
  border:1px solid rgba(30,64,175,0.55);
  box-shadow:0 10px 22px rgba(15,23,42,0.85);
}

/* RESULTADOS */
.score{
  font-size:34px;
  font-weight:800;
  letter-spacing:0.04em;
  color:var(--accent-soft);
}
.score-human{
  color:#e5e7eb;
}
.badge-tag{
  display:inline-flex;
  align-items:center;
  padding:4px 9px;
  border-radius:999px;
  font-size:11px;
  letter-spacing:0.04em;
  text-transform:uppercase;
  border:1px solid rgba(148,163,184,0.6);
  background:radial-gradient(circle at 0 0,rgba(148,163,184,0.35),transparent 60%),#020617;
}

/* HISTORIAL */
.hist-list{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-top:10px;
}
.hist-item{
  display:flex;
  gap:10px;
  align-items:center;
  padding:8px 9px;
  border-radius:var(--radius-md);
  background:linear-gradient(135deg,rgba(15,23,42,0.96),rgba(15,23,42,0.88));
  border:1px solid rgba(30,64,175,0.6);
  box-shadow:0 10px 26px rgba(15,23,42,0.9);
  cursor:pointer;
  transition:transform var(--transition-fast),box-shadow var(--transition-fast),border-color var(--transition-fast),background 180ms ease-out;
}
.hist-item:hover{
  transform:translateY(-1px);
  border-color:rgba(56,189,248,0.9);
  box-shadow:
    0 12px 30px rgba(15,23,42,0.95),
    0 0 0 1px rgba(56,189,248,0.5);
  background:radial-gradient(circle at 0 0,rgba(56,189,248,0.16),transparent 60%),rgba(15,23,42,0.98);
}
.hist-thumb{
  width:60px;
  height:44px;
  object-fit:cover;
  border-radius:var(--radius-sm);
  border:1px solid rgba(148,163,184,0.85);
  box-shadow:0 8px 20px rgba(0,0,0,0.9);
}
.hist-name{
  font-weight:600;
  font-size:13px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:220px;
}
.hist-prob{
  font-size:11px;
  color:var(--muted);
}

/* MODAL CONSENTIMIENTO */
.modal-bg{
  position:fixed;
  inset:0;
  background:radial-gradient(circle at 0 0,rgba(15,23,42,0.9),rgba(15,23,42,0.98));
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1200;
}
.modal{
  max-width:540px;
  width:92%;
  padding:20px 18px 18px;
  border-radius:var(--radius-lg);
  background:linear-gradient(145deg,#020617,#020720);
  border:1px solid rgba(148,163,184,0.5);
  box-shadow:
    0 18px 45px rgba(0,0,0,0.95),
    0 0 0 1px rgba(15,23,42,1);
  color:var(--text);
}
.modal h3{
  margin:0 0 8px;
  color:var(--accent-soft);
}
.modal p{
  margin:0 0 14px;
  font-size:14px;
  color:var(--muted);
  line-height:1.45;
}
.modal .actions{
  display:flex;
  justify-content:flex-end;
  gap:8px;
}

/* FOOTER */
footer{
  margin-top:20px;
  text-align:center;
  color:var(--muted);
  font-size:13px;
}

/* UTILIDADES */
.row{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.small{font-size:12px}
.hidden{display:none!important}
</style>
</head>
<body>
  <div id="modalConsent" class="modal-bg" style="display:flex" aria-hidden="false">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="consentTitle" aria-describedby="consentDesc">
      <h3 id="consentTitle">Términos y consentimiento</h3>
      <p id="consentDesc">
        Al continuar aceptas que las imágenes subidas se procesarán localmente en tu navegador para
        analizar su posible origen (IA o real). Las imágenes <strong>NO</strong> se compartirán con terceros
        salvo que lo autorices expresamente. Esta herramienta busca cumplir la Ley 1581 de 2012 y el Decreto 1377 de 2013.
      </p>
      <div class="actions">
        <button id="consentAccept" class="btn" type="button">Aceptar</button>
      </div>
    </div>
  </div>

  <div class="container">
    <header class="nav">
      <div class="brand" aria-label="Logotipo Verifimage">
        <a href="https://ibb.co/q3YwQq2B" style="display: flex; align-items: center; text-decoration: none;">
          <img 
            src="https://i.ibb.co/tTp5rj1B/Chat-GPT-Image-11-nov-2025-09-19-35-p-m.png" 
            alt="Verifimage Logo"
            style="
              height: 110px;
              width: auto;
              border-radius: 16px;
              margin-right: 14px;
              box-shadow: 0 0 12px rgba(0,255,204,0.25);
              transition: transform 0.3s ease, box-shadow 0.3s ease;
            "
            onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 0 16px rgba(0,255,204,0.45)';"
            onmouseout="this.style.transform='scale(1.0)'; this.style.boxShadow='0 0 12px rgba(0,255,204,0.25)';"
          >
        </a>
        <div>
          <h1 style="display:inline; color:#fff; font-size:1.8rem; font-weight:600; margin-left:5px;">
            Verifimage — Prototipo
          </h1>
          <p style="color:#aaa; margin-top:4px;">
            Detección de imágenes (IA vs humano) en navegador
          </p>
        </div>
      </div>
      <div id="userArea" class="muted" aria-live="polite"></div>
    </header>

    <main id="main-content">
      <section id="view-login" class="card login-wrap" aria-labelledby="loginTitle">
        <h2 id="loginTitle" style="margin-top:0">Inicia sesión</h2>
        <p class="small">Accede para analizar imágenes y guardar tu historial en este navegador.</p>
        <label class="small" for="login-username" style="margin-top:10px">Usuario</label>
        <input id="login-username" class="input" name="login-username" placeholder="tu.usuario" autocomplete="username" type="text">
        <label class="small" for="login-password" style="margin-top:8px">Contraseña</label>
        <input id="login-password" class="input" name="login-password" type="password" placeholder="*******" autocomplete="current-password">
        <div class="row" style="margin-top:12px">
          <button id="btn-login" class="btn" type="button">Ingresar</button>
          <button id="btn-show-register" class="btn secondary" type="button">Registrarse</button>
        </div>
        <div id="login-msg" class="small" style="margin-top:10px;color:var(--muted)"></div>
      </section>

      <section id="view-register" class="card login-wrap hidden" aria-labelledby="registerTitle">
        <h2 id="registerTitle" style="margin-top:0">Crear cuenta</h2>
        <label class="small" for="reg-username" style="margin-top:8px">Usuario</label>
        <input id="reg-username" class="input" name="reg-username" placeholder="nuevo.usuario" type="text">
        <label class="small" for="reg-password" style="margin-top:8px">Contraseña</label>
        <input id="reg-password" class="input" name="reg-password" type="password" placeholder="*******">
        <div class="row" style="margin-top:12px">
          <button id="btn-register" class="btn" type="button">Crear cuenta e iniciar sesión</button>
          <button id="btn-show-login" class="btn secondary" type="button">Volver</button>
        </div>
        <div id="reg-msg" class="small" style="margin-top:10px;color:var(--muted)"></div>
      </section>

      <section id="view-dashboard" class="hidden" aria-labelledby="dashTitle">
        <h2 id="dashTitle" class="visualmente-oculto" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden">Panel principal</h2>
        <div class="grid">
          <div>
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <strong>Subir imagen para análisis</strong>
                <div class="muted">Formatos: JPG / PNG / WebP (máx. 25MB)</div>
              </div>

              <div class="upload-area" id="uploadArea">
                <img id="preview" class="thumb"
                     src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="
                     alt="Vista previa de la imagen seleccionada"
                     style="display:none;max-height:260px"
                     loading="lazy" decoding="async">
                <div id="dropText">Arrastra, pega o selecciona una imagen</div>
                <div class="row" style="margin-top:8px">
                  <label class="btn" for="fileInput">Seleccionar archivo</label>
                  <button id="btn-analyze" class="btn secondary" type="button" aria-disabled="true" disabled>Preparando…</button>
                  <button id="btn-clear" class="btn secondary" type="button">Limpiar</button>
                  <input id="fileInput" type="file" accept="image/*" name="fileInput">
                </div>
                <p class="small muted" style="margin-top:8px">No compartimos imágenes con terceros sin tu consentimiento.</p>
              </div>

              <div style="margin-top:14px" class="card" aria-labelledby="exifTitle">
                <strong id="exifTitle">EXIF / Metadatos</strong>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px">
                  <div class="kv">Dispositivo: <span id="meta-device" style="font-weight:700;margin-left:6px">—</span></div>
                  <div class="kv">Fecha/Hora: <span id="meta-date" style="font-weight:700;margin-left:6px">—</span></div>
                  <div class="kv">Coordenadas: <span id="meta-gps" style="font-weight:700;margin-left:6px">—</span></div>
                  <div class="kv">Formato: <span id="meta-format" style="font-weight:700;margin-left:6px">—</span></div>
                </div>
              </div>

              <div class="card" style="margin-top:12px" aria-labelledby="quickTitle">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <strong id="quickTitle">Resultado rápido</strong>
                  <button id="btn-toggle-ela" class="btn ghost" type="button">Ver mapa ELA</button>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
                  <div>
                    <div class="small muted">Probabilidad IA</div>
                    <div id="iaScore" class="score">—</div>
                  </div>
                  <div style="text-align:right">
                    <div class="small muted">Probabilidad Humano</div>
                    <div id="humanScore" class="score" style="color:#fff">—</div>
                  </div>
                </div>
                <canvas id="elaCanvas" width="0" height="0" aria-label="Mapa ELA"></canvas>
                <div id="evidence" style="margin-top:12px" class="small muted"></div>
              </div>
            </div>
          </div>

          <aside class="panel-right" aria-labelledby="histTitle">
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <strong id="histTitle">Historial (local por usuario)</strong>
                <div><button id="btn-logout" class="btn secondary" type="button">Cerrar sesión</button></div>
              </div>
              <div id="history-list" class="hist-list" style="margin-top:10px"></div>
              <div id="history-empty" class="small muted" style="margin-top:10px">Aún no hay análisis.</div>
            </div>

            <div class="card" style="margin-top:12px">
              <strong>Privacidad &amp; Leyes</strong>
              <p class="small muted" style="margin-top:6px">Antes de analizar imágenes de personas, asegúrate de tener consentimiento explícito.</p>
            </div>
          </aside>
        </div>
      </section>

      <section id="view-result" class="hidden" aria-labelledby="resultTitle">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 id="resultTitle" style="margin:0">Resultado del análisis</h3>
            <div><a href="#" id="back-dashboard" class="small muted" role="button" aria-label="Volver al panel">← Volver</a></div>
          </div>

          <div style="display:flex;gap:18px;flex-wrap:wrap;margin-top:12px">
            <div style="flex:1;min-width:280px">
              <img id="result-image"
                   src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="
                   alt="Imagen analizada"
                   style="max-width:100%;border-radius:10px;border:1px solid rgba(255,255,255,0.04)"
                   loading="lazy" decoding="async">
            </div>
            <div style="width:320px">
              <div class="kv">Archivo: <div id="res-name" style="font-weight:700;margin-top:6px">—</div></div>
              <div style="height:10px"></div>
              <div class="kv">Probabilidad IA: <div id="res-ia" style="font-weight:800;font-size:28px;margin-top:6px;color:var(--accent)">—</div></div>
              <div style="height:8px"></div>
              <div class="kv">Probabilidad Humano: <div id="res-human" style="font-weight:800;font-size:28px;margin-top:6px;color:#fff">—</div></div>
              <div style="height:12px"></div>
              <div class="kv">Metadatos</div>
              <div style="margin-top:8px" class="small muted">
                <div><strong>Dispositivo:</strong> <span id="res-device">—</span></div>
                <div><strong>Fecha/Hora:</strong> <span id="res-date">—</span></div>
                <div><strong>GPS:</strong> <span id="res-gps">—</span></div>
              </div>
              <div id="res-reasons" style="margin-top:12px" class="small muted"></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer style="margin-top:18px;text-align:center;color:var(--muted);font-size:13px">© Verifimage — Prototipo.</footer>
  </div>

  <script>
    document.getElementById('consentAccept').addEventListener('click', ()=>{
      const modal = document.getElementById('modalConsent');
      modal.style.display='none';
      modal.setAttribute('aria-hidden','true');
      document.body.style.overflow='';
    });

    const KEYS={USERS:'verif_users_v2',SESSION:'verif_session_v2',USER_HIST:u=>`verif_hist_${u}_v2`,GLOBAL:'verif_global_results_v10'};
    function load(k,f){try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}}
    function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
    function trySave(k,v){try{localStorage.setItem(k,JSON.stringify(v));return true}catch(e){return false}}
    
    
    try {
      localStorage.setItem('verif_test_storage', '1');
      localStorage.removeItem('verif_test_storage');
    } catch (e) {
      alert("Espacio de almacenamiento lleno. Limpia el historial para continuar.");
      localStorage.clear();
    }
    
    const MAX_MB=25,PLACEHOLDER_IMG="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";

    let idbPromise=null;
    function openDB(){if(idbPromise)return idbPromise;idbPromise=new Promise((resolve,reject)=>{const req=indexedDB.open('verif_db',1);req.onupgradeneeded=e=>{const db=e.target.result;if(!db.objectStoreNames.contains('thumbs')){const s=db.createObjectStore('thumbs',{keyPath:'hash'});s.createIndex('last','last',{unique:false})}};req.onsuccess=()=>resolve(req.result);req.onerror=()=>reject(req.error)});return idbPromise}
    function dataURLToBlob(u){const [h,d]=u.split(',');const m=h.match(/:(.*?);/)[1];const b=atob(d);const a=new Uint8Array(b.length);for(let i=0;i<b.length;i++)a[i]=b.charCodeAt(i);return new Blob([a],{type:m})}
    function reqAsPromise(req){return new Promise((res,rej)=>{req.onsuccess=()=>res(req.result);req.onerror=()=>rej(req.error)})}
    function txComplete(tx){return new Promise((res,rej)=>{tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error)})}
    async function idbPutThumb(hash,dataURL){const db=await openDB();const blob=dataURLToBlob(dataURL);const tx=db.transaction('thumbs','readwrite');const st=tx.objectStore('thumbs');try{await reqAsPromise(st.put({hash,blob,last:Date.now()}))}catch(e){await idbEvictOld(10);await reqAsPromise(st.put({hash,blob,last:Date.now()}))}await txComplete(tx)}
    async function idbGetThumbURL(hash){const db=await openDB();const tx=db.transaction('thumbs','readwrite');const st=tx.objectStore('thumbs');const rec=await reqAsPromise(st.get(hash));if(rec){rec.last=Date.now();st.put(rec);await txComplete(tx);return URL.createObjectURL(rec.blob)}await txComplete(tx);return null}
    async function idbEvictOld(n=5){const db=await openDB();const tx=db.transaction('thumbs','readwrite');const st=tx.objectStore('thumbs');const idx=st.index('last');const keys=await new Promise(res=>{const arr=[];const cur=idx.openCursor();cur.onsuccess=e=>{const c=e.target.result;if(c){arr.push(c.primaryKey);c.continue()}else res(arr)}});for(let i=0;i<Math.min(n,keys.length);i++)await reqAsPromise(st.delete(keys[i]));await txComplete(tx)}

    const BTN_ANALYZE=document.getElementById('btn-analyze');
    function setAnalyzeReady(r){BTN_ANALYZE.disabled=!r;BTN_ANALYZE.setAttribute('aria-disabled',String(!r));BTN_ANALYZE.textContent=r?'Analizar':'Preparando…'}
    setAnalyzeReady(false);
    function currentUser(){return localStorage.getItem(KEYS.SESSION)}
    function setSession(u){if(u)localStorage.setItem(KEYS.SESSION,u);else localStorage.removeItem(KEYS.SESSION);renderSession()}
    function renderSession(){document.getElementById('userArea').textContent=currentUser()?`Sesión: ${currentUser()}`:''}
    function showView(id){['view-login','view-register','view-dashboard','view-result'].forEach(v=>document.getElementById(v).classList.add('hidden'));document.getElementById(id).classList.remove('hidden');window.scrollTo({top:0,behavior:'smooth'})}

    document.getElementById('btn-show-register').onclick=()=>{document.getElementById('login-msg').textContent='';showView('view-register')};
    document.getElementById('btn-show-login').onclick=()=>{document.getElementById('reg-msg').textContent='';showView('view-login')};
    document.getElementById('btn-register').onclick=()=>{const u=document.getElementById('reg-username').value.trim(),p=document.getElementById('reg-password').value.trim();const m=document.getElementById('reg-msg');if(!u||!p){m.textContent='Completa usuario y contraseña.';return}const users=load(KEYS.USERS,{});if(users[u]){m.textContent='Usuario ya existe.';return}users[u]={p};save(KEYS.USERS,users);setSession(u);if(typeof initAfterLogin==='function')initAfterLogin();showView('view-dashboard')};
    document.getElementById('btn-login').onclick=()=>{const u=document.getElementById('login-username').value.trim(),p=document.getElementById('login-password').value.trim();const m=document.getElementById('login-msg');if(!u||!p){m.textContent='Completa usuario y contraseña.';return}const users=load(KEYS.USERS,{});if(!users[u]){m.textContent='Usuario no encontrado.';return}if(users[u].p!==p){m.textContent='Contraseña incorrecta.';return}setSession(u);document.getElementById('login-username').value='';document.getElementById('login-password').value='';initAfterLogin();showView('view-dashboard')};
    document.getElementById('btn-logout').onclick=()=>{setSession('');showView('view-login')};

    const fileInput=document.getElementById('fileInput'),preview=document.getElementById('preview'),uploadArea=document.getElementById('uploadArea');
    let currentFile=null,currentDataURL=null,currentHash=null,currentMeta={},lastELAData=null;
    const workerBlob=new Blob([`self.onmessage=async({data})=>{const{buf}=data;const h=await crypto.subtle.digest('SHA-256',buf);const hex=[...new Uint8Array(h)].map(b=>b.toString(16).padStart(2,'0')).join('');self.postMessage({hash:hex})};`],{type:'application/javascript'});
    const hashWorker=new Worker(URL.createObjectURL(workerBlob));
    function computeHashInWorker(file){return new Promise(async res=>{hashWorker.onmessage=e=>res(e.data.hash);const buf=await file.arrayBuffer();hashWorker.postMessage({buf},[buf])})}
    function isValidImage(f){const t=['image/jpeg','image/png','image/webp'];if(!t.includes(f.type))return false;if(f.size>MAX_MB*1024*1024)return false;return true}
    fileInput.addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;if(!isValidImage(f)){alert('Formato o tamaño no permitido. Usa JPG/PNG/WebP <= 25MB.');return}loadFile(f)});
    uploadArea.addEventListener('dragover',e=>{e.preventDefault()});
    uploadArea.addEventListener('drop',e=>{e.preventDefault();const f=[...e.dataTransfer.files].find(isValidImage);if(f)loadFile(f)});
    window.addEventListener('paste',e=>{const f=[...(e.clipboardData?.files||[])].find(isValidImage);if(f)loadFile(f)});

    async function loadFile(file){
      if (file.size > MAX_MB * 1024 * 1024) {
        alert(`La imagen supera ${MAX_MB}MB. Por favor, comprímela o usa otra.`);
        return;
      }
      setAnalyzeReady(false);
      currentFile=file;
      lastELAData=null;
      if (preview.src && preview.src.startsWith('blob:')) {
        try { URL.revokeObjectURL(preview.src); } catch {}
      }
      const url=URL.createObjectURL(file);
      preview.src=url;
      preview.style.display='block';
      document.getElementById('dropText').style.display='none';
      const fr=new FileReader();
      fr.onload=ev=>{currentDataURL=ev.target.result};
      fr.readAsDataURL(file);
      currentHash=await computeHashInWorker(file);
      readEXIF(file);
      setAnalyzeReady(true)
    }
    function readEXIF(file){EXIF.getData(file,function(){const tags=EXIF.getAllTags(this);const make=tags.Make||'',model=tags.Model||'';const device=(make||model)?(make+' '+model).trim():'Sin datos';const date=tags.DateTimeOriginal||tags.DateTime||'Sin datos';let gps='No';if(tags.GPSLatitude&&tags.GPSLongitude){const lat=toDecimal(tags.GPSLatitude,tags.GPSLatitudeRef);const lon=toDecimal(tags.GPSLongitude,tags.GPSLongitudeRef);gps=lat.toFixed(6)+', '+lon.toFixed(6)};document.getElementById('meta-device').textContent=device;document.getElementById('meta-date').textContent=date;document.getElementById('meta-gps').textContent=gps;document.getElementById('meta-format').textContent=file.type||'—';currentMeta={device,date,gps,type:file.type}})}
    function toDecimal(coords,ref){try{const d=coords[0].numerator/coords[0].denominator;const m=coords[1].numerator/coords[1].denominator;const s=coords[2].numerator/coords[2].denominator;let v=d+(m/60)+(s/3600);if(ref==='S'||ref==='W')v=-v;return v}catch{return 0}}

    async function standardizeToCanvas(dataURL, maxDim = 1024) {
      const img = new Image();
      img.src = dataURL;
      await img.decode();

      const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
      const w = Math.max(1, Math.round(img.width * scale));
      const h = Math.max(1, Math.round(img.height * scale));

      const c = document.createElement('canvas');
      c.width = w;
      c.height = h;
      const ctx = c.getContext('2d', { willReadFrequently: true });

      ctx.filter = 'brightness(1) contrast(1)';
      ctx.drawImage(img, 0, 0, w, h);

      return { canvas: c, ctx, w, h };
    }

    async function readRGBA(dataURL, maxDim = 1024) {
      const { canvas: c, ctx, w, h } = await standardizeToCanvas(dataURL, maxDim);
      const { data } = ctx.getImageData(0, 0, w, h);
      return [data, w, h, c, ctx];
    }

    async function ELA_score(dataURL) {
      const [rgba, w, h, c1, ctx1] = await readRGBA(dataURL, 1024);

      const recompressed = c1.toDataURL('image/jpeg', 0.72);
      const [rgba2] = await readRGBA(recompressed, 1024);

      let errSum = 0, hot = 0, N = w * h;
      const elaMap = new Uint8ClampedArray(w * h * 4);

      for (let i = 0, j = 0; i < rgba.length; i += 4, j++) {
        const e =
          Math.abs(rgba[i] - rgba2[i]) +
          Math.abs(rgba[i + 1] - rgba2[i + 1]) +
          Math.abs(rgba[i + 2] - rgba2[i + 2]);

        errSum += e;
        if (e > 28) hot++;

        const v = Math.min(255, Math.round(e * 5));
        elaMap[i] = v; elaMap[i + 1] = v; elaMap[i + 2] = v; elaMap[i + 3] = 255;
      }

      const mae = errSum / (3 * N);
      const hotspot = hot / N;
      const score = Math.max(0, Math.min(100, Math.round(65 * hotspot + 5.5 * mae)));

      return { score, map: { w, h, data: elaMap } };
    }

    function edgeVarianceScore(rgba, w, h) {
      const Y = new Float32Array(w * h);
      for (let i = 0, j = 0; i < rgba.length; i += 4, j++) {
        Y[j] = 0.2126 * rgba[i] + 0.7152 * rgba[i + 1] + 0.0722 * rgba[i + 2];
      }

      const G = new Float32Array(w * h);
      const gx = [-1, 0, 1, -2, 0, 2, -1, 0, 1];
      const gy = [-1, -2, -1, 0, 0, 0, 1, 2, 1];

      for (let y = 1; y < h - 1; y++) {
        for (let x = 1; x < w - 1; x++) {
          let sx = 0, sy = 0, k = 0;
          for (let yy = -1; yy <= 1; yy++) {
            for (let xx = -1; xx <= 1; xx++, k++) {
              const v = Y[(y + yy) * w + (x + xx)];
              sx += gx[k] * v;
              sy += gy[k] * v;
            }
          }
          G[y * w + x] = Math.hypot(sx, sy);
        }
      }

      let sum = 0, sum2 = 0, n = G.length;
      for (let i = 0; i < n; i++) { const v = G[i]; sum += v; sum2 += v * v; }
      const mean = sum / n, vari = Math.max(0, sum2 / n - mean * mean);

      return Math.max(0, Math.min(100, Math.round(100 * (1 - Math.exp(-vari / 1600)))));
    }

    function toGray(rgba, w, h) {
      const Y = new Float32Array(w*h);
      for (let i=0,j=0; i<rgba.length; i+=4, j++)
        Y[j] = 0.2126*rgba[i] + 0.7152*rgba[i+1] + 0.0722*rgba[i+2];
      return Y;
    }

    function entropyY(rgba, w, h) {
      const hist = new Uint32Array(256);
      for (let i=0; i<rgba.length; i+=4) {
        const y = Math.max(0, Math.min(255, Math.round(
          0.2126*rgba[i] + 0.7152*rgba[i+1] + 0.0722*rgba[i+2]
        )));
        hist[y]++;
      }
      const N = (rgba.length/4) || 1;
      let H = 0;
      for (let i=0;i<256;i++){
        if (!hist[i]) continue;
        const p = hist[i]/N;
        H -= p * Math.log2(p);
      }
      return Math.max(0, Math.min(100, Math.round((H/8)*100)));
    }

    function laplacianHFScore(rgba, w, h) {
      const Y = toGray(rgba,w,h);
      let sum=0,sum2=0,n=0;
      for (let y=1;y<h-1;y++){
        for (let x=1;x<w-1;x++){
          const i=y*w+x;
          const L = -4*Y[i] + Y[i-1]+Y[i+1]+Y[i-w]+Y[i+w];
          sum += Math.abs(L);
          sum2 += L*L;
          n++;
        }
      }
      const mean = sum/n;
      const varL = sum2/n - mean*mean;
      const hf = Math.max(0, Math.min(100, Math.round( 100 * (1 - Math.exp(-varL/1500)) )));
      return hf;
    }

    function noiseVarScore(rgba, w, h) {
      const Y = toGray(rgba,w,h);
      const blur = new Float32Array(w*h);
      for (let y=1;y<h-1;y++){
        for (let x=1;x<w-1;x++){
          let s=0; for(let yy=-1;yy<=1;yy++) for(let xx=-1;xx<=1;xx++) s+=Y[(y+yy)*w+(x+xx)];
          blur[y*w+x]=s/9;
        }
      }
      let sum=0,sum2=0,n=0;
      for (let y=1;y<h-1;y++){
        for (let x=1;x<w-1;x++){
          const r = Y[y*w+x]-blur[y*w+x];
          sum+=r; sum2+=r*r; n++;
        }
      }
      const varN = sum2/n - (sum/n)*(sum/n);
      return Math.max(0, Math.min(100, Math.round(100*(1 - Math.exp(-varN/500)))));
    }

    function jpegBlockinessScore(rgba, w, h) {
      const Y = toGray(rgba,w,h);
      let bSum=0, bN=0, iSum=0, iN=0;
      for (let x=8; x<w; x+=8) {
        for (let y=0; y<h; y++) {
          const i = y*w + x;
          if (x>0 && x<w) {
            bSum += Math.abs(Y[i]-Y[i-1]); bN++;
          }
        }
      }
      for (let y=8; y<h; y+=8) {
        for (let x=0; x<w; x++) {
          const i = y*w + x;
          if (y>0 && y<h) {
            bSum += Math.abs(Y[i]-Y[i-w]); bN++;
          }
        }
      }
      for (let y=1; y<h; y+=9) {
        for (let x=1; x<w; x+=9) {
          const i = y*w + x;
          iSum += Math.abs(Y[i]-Y[i-1]||0) + Math.abs(Y[i]-Y[i-w]||0);
          iN += 2;
        }
      }
      const b = bN? bSum/bN : 0;
      const inr = iN? iSum/iN : 1;
      const ratio = inr>0? b/inr : b;
      return Math.max(0, Math.min(100, Math.round( 100 * Math.min(1, ratio/1.4) )));
    }

    function paletteSizeBinned(rgba, step = 32) {
      const seen = new Set();
      for (let i = 0; i < rgba.length; i += 4) {
        const r = Math.floor(rgba[i]/step);
        const g = Math.floor(rgba[i+1]/step);
        const b = Math.floor(rgba[i+2]/step);
        seen.add((r<<10)|(g<<5)|b);
        if (seen.size > 256) break;
      }
      return seen.size;
    }

    function flatnessRatio3x3(rgba, w, h, thr = 35) {
      let flats=0,total=0;
      const idx=(x,y)=>4*(y*w+x);
      for (let y=1;y<h-1;y+=2){
        for (let x=1;x<w-1;x+=2){
          let mean=0,mean2=0,n=0;
          for(let yy=-1;yy<=1;yy++) for(let xx=-1;xx<=1;xx++){
            const i=idx(x+xx,y+yy);
            const Y=0.2126*rgba[i]+0.7152*rgba[i+1]+0.0722*rgba[i+2];
            mean+=Y; mean2+=Y*Y; n++;
          }
          const varLocal=mean2/n-(mean/n)*(mean/n);
          if (varLocal<thr) flats++;
          total++;
        }
      }
      return total? flats/total : 0;
    }

    
    function isColorfulIllustration(rgba, w, h, meta) {
      let total = 0, sumS = 0, sumV = 0;
      for (let i = 0; i < rgba.length; i += 16) {
        const r = rgba[i], g = rgba[i+1], b = rgba[i+2];
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        const s = max === 0 ? 0 : (max - min) / max;
        const v = max / 255;
        sumS += s;
        sumV += v;
        total++;
      }
      const meanSat = total ? sumS / total : 0;
      const meanVal = total ? sumV / total : 0;

      const palette = paletteSizeBinned(rgba, 32);
      const flat = flatnessRatio3x3(rgba, w, h, 30);

      const fileType = (meta?.type || '').toLowerCase();
      const isIllustrationType = fileType.includes('png') || fileType.includes('webp');
      const noDevice = !meta || meta.device === 'Sin datos';

      return (
        meanSat > 0.6 &&
        meanVal > 0.4 &&
        palette < 90 &&
        flat > 0.25 && flat < 0.8 &&
        isIllustrationType &&
        noDevice
      );
    }

    function isSurrealPhotoAI(rgba, meta) {
      let total = 0;
      let sumSat = 0;
      let sumVal = 0;
      let dark = 0;
      let bright = 0;

      for (let i = 0; i < rgba.length; i += 16) {
        const r = rgba[i], g = rgba[i+1], b = rgba[i+2];
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);

        const v = max / 255;
        const s = max === 0 ? 0 : (max - min) / max;

        sumSat += s;
        sumVal += v;
        total++;

        if (v < 0.22) dark++;
        if (v > 0.78) bright++;
      }

      if (!total) return false;

      const meanSat = sumSat / total;
      const meanVal = sumVal / total;
      const darkFrac = dark / total;
      const brightFrac = bright / total;

      const noDevice = !meta || meta.device === 'Sin datos';
      const fileType = (meta?.type || '').toLowerCase();
      const isPhotoLike =
        fileType.includes('jpg') ||
        fileType.includes('jpeg') ||
        fileType.includes('png') ||
        fileType.includes('webp');

      return (
        noDevice &&
        isPhotoLike &&
        meanSat > 0.50 &&
        meanVal > 0.30 &&
        darkFrac  > 0.08 &&
        brightFrac > 0.08
      );
    }

    function edgeDensitySobel(rgba,w,h,T=80){
      const Y=toGray(rgba,w,h); let strong=0,N=0;
      for (let y=1;y<h-1;y+=2){
        for (let x=1;x<w-1;x+=2){
          const i=y*w+x;
          const gx = -Y[i-w-1]-2*Y[i-1]-Y[i+w-1] + Y[i-w+1]+2*Y[i+1]+Y[i+w+1];
          const gy = -Y[i-w-1]-2*Y[i-w]-Y[i-w+1] + Y[i+w-1]+2*Y[i+w]+Y[i+w+1];
          const mag=Math.hypot(gx,gy); if(mag>T) strong++; N++;
        }
      }
      return N? strong/N : 0;
    }

    function illustrationScore(rgba, w, h, meta) {
      const palette = paletteSizeBinned(rgba, 32);
      const flat    = flatnessRatio3x3(rgba, w, h);
      const edens   = edgeDensitySobel(rgba, w, h);
      const hasAlpha = (()=>{for(let i=3;i<rgba.length;i+=4) if(rgba[i]<255) return true; return false;})();
      const isPNG = (meta?.type||'').includes('png');

      const palSmall   = 1 - Math.min(1, palette/96);
      const flatStrong = Math.min(1, flat/0.45);
      const edgeSweet  = (edens>0.06 && edens<0.35) ? 1 : 0;

      let score = 0;
      score += 45 * palSmall;
      score += 35 * flatStrong;
      score += 12 * edgeSweet;
      if (hasAlpha || isPNG) score += 8;

      return Math.max(0, Math.min(100, Math.round(score)));
    }

    async function computeScores(dataURL, meta) {
      const [rgba, w, h] = await readRGBA(dataURL, 1024);
      const colorfulIllustration = isColorfulIllustration(rgba, w, h, meta);
      const surrealPhotoAI = isSurrealPhotoAI(rgba, meta);

      const { score: ela, map } = await ELA_score(dataURL);
      lastELAData = map;

      const edge = edgeVarianceScore(rgba, w, h);

      const hist = new Uint32Array(256);
      for (let i = 0; i < rgba.length; i += 4) {
        const y = Math.max(0, Math.min(255, Math.round(
          0.2126 * rgba[i] + 0.7152 * rgba[i+1] + 0.0722 * rgba[i+2]
        )));
        hist[y]++;
      }
      const N = (rgba.length / 4) || 1;
      let H = 0;
      for (let i = 0; i < 256; i++) {
        if (!hist[i]) continue;
        const p = hist[i] / N;
        H -= p * Math.log2(p);
      }
      const entropy = Math.max(0, Math.min(100, Math.round((H / 8) * 100)));

      const Y = new Float32Array(w*h);
      for (let i = 0, j = 0; i < rgba.length; i += 4, j++) {
        Y[j] = 0.2126 * rgba[i] + 0.7152 * rgba[i+1] + 0.0722 * rgba[i+2];
      }
      let sumL = 0, sumL2 = 0, nL = 0;
      for (let y = 1; y < h-1; y++) {
        for (let x = 1; x < w-1; x++) {
          const i = y*w + x;
          const L = -4 * Y[i] + Y[i-1] + Y[i+1] + Y[i-w] + Y[i+w];
          sumL += Math.abs(L);
          sumL2 += L*L;
          nL++;
        }
      }
      const meanL = sumL / nL;
      const varL = Math.max(0, sumL2 / nL - meanL*meanL);
      const hf = Math.max(0, Math.min(100, Math.round(100 * (1 - Math.exp(-varL / 1500)))));

      const seen = new Set();
      for (let i = 0; i < rgba.length; i += 4) {
        const r = Math.floor(rgba[i] / 32);
        const g = Math.floor(rgba[i+1] / 32);
        const b = Math.floor(rgba[i+2] / 32);
        seen.add((r<<10) | (g<<5) | b);
        if (seen.size > 256) break;
      }
      const palette = seen.size;
      const palSmall = 1 - Math.min(1, palette / 96);

      let flats = 0, totalPatch = 0;
      const idx = (x,y) => 4*(y*w + x);
      for (let y = 1; y < h-1; y += 2) {
        for (let x = 1; x < w-1; x += 2) {
          let m = 0, m2 = 0, n = 0;
          for (let yy=-1; yy<=1; yy++) {
            for (let xx=-1; xx<=1; xx++) {
              const i = idx(x+xx, y+yy);
              const yv = 0.2126*rgba[i] + 0.7152*rgba[i+1] + 0.0722*rgba[i+2];
              m += yv; m2 += yv*yv; n++;
            }
          }
          const vloc = m2/n - (m/n)*(m/n);
          if (vloc < 35) flats++;
          totalPatch++;
        }
      }
      const flatRatio = totalPatch ? flats/totalPatch : 0;

      let strong = 0, Nb = 0;
      for (let y = 1; y < h-1; y += 2) {
        for (let x = 1; x < w-1; x += 2) {
          const i = y*w + x;
          const gx = -Y[i-w-1]-2*Y[i-1]-Y[i+w-1] + Y[i-w+1]+2*Y[i+1]+Y[i+w+1];
          const gy = -Y[i-w-1]-2*Y[i-w]-Y[i-w+1] + Y[i+w-1]+2*Y[i+w]+Y[i+w+1];
          const mag = Math.hypot(gx, gy);
          if (mag > 80) strong++;
          Nb++;
        }
      }
      const edgeDensity = Nb ? strong/Nb : 0;

      const flatStrong = Math.min(1, flatRatio / 0.45);
      const edgeSweet = (edgeDensity > 0.06 && edgeDensity < 0.35) ? 1 : 0;

      const hasAlpha = (() => {
        for (let i = 3; i < rgba.length; i += 4) if (rgba[i] < 255) return true;
        return false;
      })();
      const isPNG = (meta?.type || '').includes('png');

      let ilu = 0;
      ilu += 45 * palSmall;
      ilu += 35 * flatStrong;
      ilu += 12 * edgeSweet;
      if (hasAlpha || isPNG) ilu += 8;
      ilu = Math.max(0, Math.min(100, Math.round(ilu)));

      const natural = Math.round(0.45*hf + 0.30*entropy + 0.25*(100*flatStrong ? (1-flatStrong) : 1));

      let aux = 0;
      if (!meta || meta.device === 'Sin datos') aux += 2;
      if ((meta?.gps || 'No') === 'No') aux += 1;
      if (aux > 5) aux = 5;

      let ia;
      if (ilu >= 55) {
        ia = 0.30*ela + 0.20*(100-hf) + 0.25*ilu + 0.15*(100-entropy) + 0.10*(100-natural) + aux;
        if (ilu >= 70) ia = Math.max(ia, Math.round(0.8*ilu));
      } else {
        ia = 0.50*ela + 0.25*(100-natural) + 0.15*(100-entropy) + 0.10*(100-edge) + aux;
      }

      
      if (surrealPhotoAI && ia < 85) {
        ia = 85;
      }

      if (colorfulIllustration && ia < 75) {
        ia = 75;
      }

      if (meta && meta.device && meta.device !== 'Sin datos') {
        const dev = meta.device.toLowerCase();

        const isPhone = /(iphone|ipad|ipod|android|samsung|galaxy|xiaomi|redmi|huawei|motorola|moto|pixel|oneplus|oppo|vivo|realme|nokia|lg|sony)/.test(dev);

        if (isPhone && ia > 30) {
          ia = 30; 
        }
      }

      ia = Math.max(0, Math.min(100, Math.round(ia)));
      const human = 100 - ia;

      return { ia, human, ela, edge };
    }

    function basicWatermarkCheck(file){const name=(file.name||'').toLowerCase();const s=['watermark','stock','unsplash','pexels','pixabay','istock','shutterstock','midjourney','dalle','stable','ai'];return s.some(x=>name.includes(x))}
    function exifPresent(m){return !!(m&&((m.device&&m.device!=='Sin datos')||(m.date&&m.date!=='Sin datos')))}

    function loadGlobal(){return load(KEYS.GLOBAL,{})}
    function safeSaveGlobal(hash,obj){const g=loadGlobal();const {thumb,...rest}=obj;g[hash]=rest;trySave(KEYS.GLOBAL,g)}
    function userHistKey(u){return KEYS.USER_HIST(u)}
    function loadUserHist(u){if(!u)return[];return load(userHistKey(u),[])}
    function safeSaveUserHist(u,arr){trySave(KEYS.USER_HIST(u),arr)}

    document.getElementById('btn-analyze').addEventListener('click',async()=>{if(!currentFile||!currentHash){alert('Selecciona una imagen primero y espera a que cargue.');return}let ok=false;document.getElementById('iaScore').textContent='Analizando…';document.getElementById('humanScore').textContent='Analizando…';document.getElementById('evidence').innerHTML='';document.getElementById('elaCanvas').style.display='none';try{const heur={watermark:basicWatermarkCheck(currentFile),noExif:!exifPresent(currentMeta),exifConsistent:exifPresent(currentMeta)};const global=loadGlobal();const cached=global[currentHash];if(cached){await idbPutThumb(currentHash,currentDataURL);showResult({...cached,thumb:currentDataURL});addUserHistoryIfMissing(currentHash,cached);backfillAndSyncHistory();renderHistory();ok=true;return}const {ia,human,ela,edge}=await computeScores(currentDataURL,currentMeta);const reasons=[`ELA (compresión diferencial): ${ela}/100`,`Suavidad/bordes (Sobel/varianza): ${edge}/100`,heur.exifConsistent?'EXIF presente (posible origen cámara)':'Sin EXIF (posible web/manipulación)',heur.watermark?'Nombre sugiere watermark/stock':'Sin indicios textuales de watermark'];await idbPutThumb(currentHash,currentDataURL);const storedObj={schema_v:3,hash:currentHash,ia,human,reasons,meta:{device:currentMeta.device||'—',date:currentMeta.date||'—',gps:currentMeta.gps||'—',type:currentMeta.type||'—'},name:currentFile.name||'Imagen',when:new Date().toLocaleString()};safeSaveGlobal(currentHash,storedObj);saveRecordToUserHistory({...storedObj});showResult({...storedObj,thumb:currentDataURL});backfillAndSyncHistory();renderHistory();ok=true}catch(e){console.error('Analyze error:',e);alert('No se pudo completar el análisis. Intenta con una imagen más liviana o en formato JPG/PNG/WebP.')}finally{if(!ok){document.getElementById('iaScore').textContent='—';document.getElementById('humanScore').textContent='—';document.getElementById('evidence').innerHTML=''}}});

    function showResult(st){document.getElementById('iaScore').textContent=st.ia+'%';document.getElementById('humanScore').textContent=st.human+'%';document.getElementById('evidence').innerHTML=`<div style="margin-top:8px;color:var(--muted)"><strong>Evidencia:</strong><ul style="margin:6px 0 0 18px">${st.reasons.map(r=>`<li>${escapeHTML(r)}</li>`).join('')}</ul></div>`;document.getElementById('res-name').textContent=st.name||'—';document.getElementById('res-ia').textContent=st.ia+'%';document.getElementById('res-human').textContent=st.human+'%';document.getElementById('res-device').textContent=st.meta.device||'—';document.getElementById('res-date').textContent=st.meta.date||'—';document.getElementById('res-gps').textContent=st.meta.gps||'—';document.getElementById('result-image').src=st.thumb||PLACEHOLDER_IMG}

    function saveRecordToUserHistory(st){const u=currentUser();if(!u)return;const hist=loadUserHist(u);if(hist.find(x=>x.hash===st.hash))return;const rec={id:Date.now(),hash:st.hash,name:st.name||currentFile.name||'Imagen',when:st.when||new Date().toLocaleString(),ia:st.ia,human:st.human,meta:st.meta||{}};hist.unshift(rec);if(hist.length>1000)hist.splice(1000);safeSaveUserHist(u,hist)}
    function addUserHistoryIfMissing(hash,st){const u=currentUser();if(!u)return;const hist=loadUserHist(u);if(hist.find(x=>x.hash===hash))return;const rec={id:Date.now(),hash,name:st.name||'Imagen',when:new Date().toLocaleString(),ia:st.ia,human:st.human,meta:st.meta||{}};hist.unshift(rec);safeSaveUserHist(u,hist)}
    function truncateMiddle(s,m=36){if(!s)return'';if(s.length<=m)return s;const p=Math.floor((m-3)/2);return s.slice(0,p)+'…'+s.slice(s.length-p)}
    function escapeHTML(s){return(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))}

    async function renderHistory(){const u=currentUser();const list=document.getElementById('history-list');const empty=document.getElementById('history-empty');list.innerHTML='';if(!u){empty.textContent='Inicia sesión para ver el historial.';empty.style.display='block';return}const data=loadUserHist(u);if(!data||data.length===0){empty.style.display='block';return}empty.style.display='none';const global=loadGlobal();let dirty=false;for(const r of data){const div=document.createElement('div');div.className='hist-item fade';const img=document.createElement('img');img.className='hist-thumb';img.alt='';idbGetThumbURL(r.hash).then(url=>{img.src=url||PLACEHOLDER_IMG}).catch(()=>{img.src=PLACEHOLDER_IMG});const g=global[r.hash];const iaNow=typeof g?.ia==='number'?g.ia:r.ia;const humanNow=typeof g?.human==='number'?g.human:r.human;if(r.ia!==iaNow||r.human!==humanNow){r.ia=iaNow;r.human=humanNow;dirty=true}const meta=document.createElement('div');meta.className='hist-meta';const name=document.createElement('div');name.className='hist-name';name.title=r.name;name.textContent=truncateMiddle(r.name,36);const sub=document.createElement('div');sub.className='hist-sub';sub.textContent=`${r.when} · IA ${iaNow}% · Humano ${humanNow}%`;meta.appendChild(name);meta.appendChild(sub);const right=document.createElement('div');right.style.minWidth='56px';right.style.textAlign='right';const badge=document.createElement('span');badge.className='badge';badge.style.fontSize='12px';badge.textContent=iaNow>=60?'POSIBLE IA':'PREDOMINANTEMENTE REAL';right.appendChild(badge);div.appendChild(img);div.appendChild(meta);div.appendChild(right);div.onclick=()=>openHistoryRecord(r);list.appendChild(div)}if(dirty){trySave(KEYS.USER_HIST(u),data)}}

    async function openHistoryRecord(r){const global=loadGlobal();const st=global[r.hash];const url=await idbGetThumbURL(r.hash);document.getElementById('result-image').src=url||PLACEHOLDER_IMG;document.getElementById('res-name').textContent=r.name;if(st){document.getElementById('res-ia').textContent=st.ia+'%';document.getElementById('res-human').textContent=st.human+'%';document.getElementById('res-device').textContent=st.meta?.device||r.meta?.device||'—';document.getElementById('res-date').textContent=st.meta?.date||r.meta?.date||'—';document.getElementById('res-gps').textContent=st.meta?.gps||r.meta?.gps||'—';document.getElementById('res-reasons').innerHTML=`<div style="margin-top:8px;color:var(--muted)"><strong>Evidencias:</strong><ul style="margin:6px 0 0 18px">${(st.reasons||[]).map(x=>`<li>${escapeHTML(x)}</li>`).join('')}</ul></div>`}else{document.getElementById('res-ia').textContent=r.ia+'%';document.getElementById('res-human').textContent=r.human+'%';document.getElementById('res-device').textContent=r.meta?.device||'—';document.getElementById('res-date').textContent=r.meta?.date||'—';document.getElementById('res-gps').textContent=r.meta?.gps||'—';document.getElementById('res-reasons').textContent='Resultado del historial'}showView('view-result')}

    async function backfillAndSyncHistory(){const u=currentUser();if(!u)return;const g=loadGlobal();let cg=false;for(const[hash,rec]of Object.entries(g)){if(rec&&rec.thumb&&typeof rec.thumb==='string'&&rec.thumb.startsWith('data:')){try{await idbPutThumb(hash,rec.thumb)}catch{}delete rec.thumb;cg=true}}if(cg)trySave(KEYS.GLOBAL,g);const hist=loadUserHist(u);if(!hist||hist.length===0)return;let ch=false;for(let i=0;i<hist.length;i++){const r=hist[i];const gr=g[r.hash];if(gr&&(r.ia!==gr.ia||r.human!==gr.human)){hist[i]={...r,ia:gr.ia,human:gr.human};ch=true}}if(ch)trySave(KEYS.USER_HIST(u),hist)}

    document.getElementById('back-dashboard').onclick=e=>{e.preventDefault();showView('view-dashboard')};
    document.getElementById('btn-clear').onclick=()=>{fileInput.value='';preview.src=PLACEHOLDER_IMG;preview.style.display='none';document.getElementById('dropText').style.display='block';document.getElementById('result-image').src=PLACEHOLDER_IMG;currentFile=null;currentDataURL=null;currentHash=null;currentMeta={};document.getElementById('meta-device').textContent='—';document.getElementById('meta-date').textContent='—';document.getElementById('meta-gps').textContent='—';document.getElementById('meta-format').textContent='—';document.getElementById('iaScore').textContent='—';document.getElementById('humanScore').textContent='—';document.getElementById('evidence').innerHTML='';setAnalyzeReady(false);lastELAData=null;document.getElementById('elaCanvas').style.display='none'};

    function initAfterLogin(){renderSession();backfillAndSyncHistory().then(renderHistory);showView('view-dashboard')}
    (function boot(){renderSession();if(currentUser()){backfillAndSyncHistory().then(renderHistory);showView('view-dashboard')}else{showView('view-login')}})();

    document.getElementById('btn-toggle-ela').addEventListener('click',()=>{
      const elac=document.getElementById('elaCanvas');
      if(!lastELAData){elac.style.display='none';return}
      elac.width=lastELAData.w;elac.height=lastELAData.h;
      const ctx=elac.getContext('2d');
      const imgData=new ImageData(lastELAData.data,lastELAData.w,lastELAData.h);
      ctx.putImageData(imgData,0,0);
      elac.style.display=elac.style.display==='none'?'block':'none';
      document.getElementById('btn-toggle-ela').textContent=elac.style.display==='none'?'Ver mapa ELA':'Ocultar mapa ELA';
    });
  </script>
</body>
</html>
